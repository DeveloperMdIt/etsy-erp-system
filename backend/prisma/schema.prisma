generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String        @id @default(uuid())
  email        String        @unique
  passwordHash String
  tenantId     String        @default(uuid())
  role         Role          @default(USER)
  firstName    String?
  lastName     String?
  
  // Etsy Integration (OAuth2)
  shopName          String?   
  etsyShopId        String?   
  etsyUserId        String?   
  etsyAccessToken   String?   
  etsyRefreshToken  String?   
  tokenExpiresAt    DateTime? 
  
  
  // Etsy Integration (OAuth2)
  shopName          String?   // Display name (e.g., "Gluecksmomente1")
  etsyShopId        String?   // Etsy Shop ID from OAuth
  etsyUserId        String?   // Etsy User ID
  etsyAccessToken   String?   // OAuth2 Access Token
  etsyRefreshToken  String?   // OAuth2 Refresh Token
  tokenExpiresAt    DateTime? // Token expiration
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  settings     UserSettings?
  products     Product[]

  @@index([tenantId])
  @@map("users")
}

model UserSettings {
  id             String   @id @default(uuid())
  userId         String   @unique
  
  // Etsy settings
  etsyShopName   String?
  
  // DHL settings
  dhlApiUsername String?
  dhlApiPassword String?
  
  // Email SMTP settings
  smtpHost       String?
  smtpPort       Int?
  smtpUsername   String?
  smtpPassword   String?
  smtpFrom       String?
  
  // Number Range Configuration
  orderNumberFormat      String   @default("BE-{YYYY}-{####}")
  orderNumberStart       Int      @default(1)
  orderNumberCurrent     Int      @default(1)
  
  invoiceNumberFormat    String   @default("RE-{YYYY}-{####}")
  invoiceNumberStart     Int      @default(1)
  invoiceNumberCurrent   Int      @default(1)
  
  deliveryNoteFormat     String   @default("LS-{YYYY}-{####}")
  deliveryNoteStart      Int      @default(1)
  deliveryNoteCurrent    Int      @default(1)
  
  supplierOrderFormat    String   @default("LB-{YYYY}-{####}")
  supplierOrderStart     Int      @default(1)
  supplierOrderCurrent   Int      @default(1)

  customerNumberFormat   String   @default("KD-{YYYY}-{####}")
  customerNumberStart    Int      @default(1)
  customerNumberCurrent  Int      @default(1)
  
  // SKU Management
  nextProductId          Int      @default(1)
  skuPrefix              String   @default("10")
  
  // Setup Status
  setupCompleted         Boolean  @default(false)
  setupCompletedAt       DateTime?
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Customer {
  id               String   @id @default(uuid())
  tenantId         String
  customerNumber   String
  email            String
  firstName        String
  lastName         String
  street           String
  addressAddition  String?
  postalCode       String
  city             String
  country          String   @default("DE")
  phone            String?
  isRepeatCustomer Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  orders           Order[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("customers")
}

model Product {
  id                                                              String               @id @default(uuid())
  userId                                                          String
  user                                                            User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId                                                        String
  sku                                                             String
  gtin                                                            String?
  type                                                            String               @default("SIMPLE")
  name                                                            String
  description                                                     String?
  weight                                                          Int
  price                                                           Float
  imageUrl                                                        String?
  images                                                          String?
  stockQuantity                                                   Int                  @default(0)
  tags                                                            String?
  materials                                                       String?
  variationType1                                                  String?
  variationName1                                                  String?
  variationValue1                                                 String?
  variationType2                                                  String?
  variationName2                                                  String?
  variationValue2                                                 String?
  isActive                                                        Boolean              @default(true)
  showInShop                                                      Boolean              @default(true)
  createdAt                                                       DateTime             @default(now())
  updatedAt                                                       DateTime             @updatedAt
  orderItems                                                      OrderItem[]
  componentChildren                                               product_components[] @relation("product_components_childProductIdToproducts")
  components                                                      product_components[] @relation("product_components_parentProductIdToproducts")
  variationChildren                                               product_variations[] @relation("product_variations_childProductIdToproducts")
  variations                                                      product_variations[] @relation("product_variations_productIdToproducts")

  @@unique([userId, sku])
  @@index([userId])
  @@index([tenantId])
  @@index([sku])
  @@index([gtin])
  @@index([isActive])
  @@map("products")
}

model Order {
  id               String            @id @default(uuid())
  tenantId         String
  orderNumber      String            @unique  // Internal: "BO-2025-0001"
  externalOrderId  String?                     // External: Etsy/Amazon Order ID
  platform         String?                     // "ETSY", "AMAZON", "MANUAL", etc.
  customerId       String
  status           OrderStatus       @default(OPEN)
  shippingCost     Float
  totalPrice       Float
  shippingProvider ShippingProvider?
  trackingNumber   String?
  shippedAt        DateTime?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  documents        Document[]
  items            OrderItem[]
  customer         Customer          @relation(fields: [customerId], references: [id])
  shippingLabels   ShippingLabel[]

  @@index([tenantId])
  @@index([status])
  @@index([externalOrderId])
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model ShippingLabel {
  id             String           @id @default(uuid())
  orderId        String
  provider       ShippingProvider
  trackingNumber String
  labelUrl       String?
  labelPath      String?
  weight         Int
  cost           Float
  createdAt      DateTime         @default(now())
  order          Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipping_labels")
}

model Document {
  id             String       @id @default(uuid())
  tenantId       String
  orderId        String?
  type           DocumentType
  documentNumber String       @unique
  filePath       String
  createdAt      DateTime     @default(now())
  order          Order?       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId])
  @@index([type])
  @@map("documents")
}

model ImportHistory {
  id             String   @id @default(uuid())
  tenantId       String
  fileName       String
  ordersImported Int
  status         String
  errorMessage   String?
  createdAt      DateTime @default(now())

  @@index([tenantId])
  @@map("import_history")
}

model product_components {
  id                                                    String   @id
  parentProductId                                       String
  childProductId                                        String
  quantity                                              Int      @default(1)
  createdAt                                             DateTime @default(now())
  updatedAt                                             DateTime
  childProduct   Product  @relation("product_components_childProductIdToproducts", fields: [childProductId], references: [id])
  parentProduct  Product  @relation("product_components_parentProductIdToproducts", fields: [parentProductId], references: [id], onDelete: Cascade)

  @@unique([parentProductId, childProductId])
  @@index([childProductId])
  @@index([parentProductId])
}

model product_variations {
  id                                                   String   @id
  productId                                            String
  childProductId                                       String?
  sku                                                  String
  price                                                Float?
  stockQuantity                                        Int      @default(0)
  name1                                                String?
  value1                                               String?
  name2                                                String?
  value2                                               String?
  createdAt                                            DateTime @default(now())
  updatedAt                                            DateTime
  childProduct Product? @relation("product_variations_childProductIdToproducts", fields: [childProductId], references: [id])
  product      Product  @relation("product_variations_productIdToproducts", fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, sku])
  @@index([childProductId])
  @@index([sku])
}

enum Role {
  ADMIN
  USER
}

enum OrderStatus {
  OPEN
  IN_PROGRESS
  SHIPPED
  CANCELLED
}

enum ShippingProvider {
  DHL_KLEINPAKET
  DHL_PAKET
  DEUTSCHE_POST_MAXIBRIEF
  OTHER
}

enum DocumentType {
  INVOICE
  DELIVERY_NOTE
  PICK_LIST
}
