generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String  @id @default(uuid())
  email        String  @unique
  passwordHash String
  tenantId     String  @default(uuid())
  role         Role    @default(USER)
  firstName    String?
  lastName     String?

  // Etsy Integration (OAuth2)
  shopName         String? // Display name (e.g., "Gluecksmomente1") 
  etsyShopId       String? // Etsy Shop ID from OAuth
  etsyUserId       String? // Etsy User ID
  etsyAccessToken  String? // OAuth2 Access Token
  etsyRefreshToken String? // OAuth2 Refresh Token

  tokenExpiresAt   DateTime? // Token expiration

  // Subscription & Billing
  subscriptionPlanId String?
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  subscriptionStatus String   @default("TRIAL") // TRIAL, ACTIVE, CANCELLED, PAST_DUE
  trialEndsAt        DateTime?


  // Admin Control
  isBlocked        Boolean @default(false)

  // Password Reset
  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // Email Verification
  isVerified           Boolean   @default(false)
  verificationToken    String?
  verificationExpires  DateTime?

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  settings  UserSettings?
  products  Product[]
  labelProfiles LabelProfile[]
  shippingProfiles ShippingProfile[]
  automationRules AutomationRule[]
  documentTemplates DocumentTemplate[]
  userModules       UserModule[]

  @@index([tenantId])
  @@map("users")
}

model Module {
  id          String   @id @default(uuid())
  key         String   @unique // e.g. "LABEL_DESIGNER"
  name        String
  description String?
  category    String   @default("Allgemein") // e.g. "Auftragsabwicklung"
  price       Float    @default(0.0)
  isActive    Boolean  @default(true) // Available for purchase?
  isPlanned   Boolean  @default(false) // "Coming Soon" badge
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userModules UserModule[] // Relation to UserModule

  @@map("modules")
}

model UserModule {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  moduleId  String
  module    Module   @relation(fields: [moduleId], references: [id])

  isActive  Boolean  @default(true)
  expiresAt DateTime? // Optional expiration date

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([moduleId])
  @@map("user_modules")
}

model SystemSetting {
  key         String   @id // e.g. "ETSY_CLIENT_ID"
  value       String
  description String?
  isEncrypted Boolean  @default(false)
  
  updatedAt   DateTime @updatedAt

  @@map("system_settings")
}

model ContentPage {
  slug        String   @id // e.g. "privacy-policy"
  title       String
  content     String   // HTML or Markdown
  isPublished Boolean  @default(true)
  
  updatedAt   DateTime @updatedAt

  @@map("content_pages")
}

model LabelProfile {
  id          String   @id @default(uuid())
  name        String   // e.g. "DHL", "Deutsche Post"
  printerName String
  format      String   // e.g. "A6", "4x6"
  layoutJson  String? // JSON string for custom layout
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@map("label_profiles")
}


model UserSettings {
  id     String @id @default(uuid())
  userId String @unique

  // Etsy settings
  etsyShopName    String?
  etsySyncEnabled Boolean @default(true) // Enable/Disable Etsy tracking sync
  lastEtsySync    DateTime? // Timestamp of last successful order sync


  // DHL settings
  dhlApiUsername String?
  dhlApiPassword String?

  // DHL Paket (Gesch√§ftskundenportal) - Customer credentials
  dhlGkpUsername String? // GKP Username (customer enters this)
  dhlGkpPassword String? // GKP Password (customer enters this)
  dhlEnabled     Boolean @default(false) // Enable/Disable DHL Paket integration
  
  // DHL OAuth & Configuration (New)
  dhlAppId          String? // Client ID for OAuth
  dhlAppSecret      String? // Client Secret for OAuth
  dhlEkp            String? // EKP (10 digits)
  dhlProcedure      String? @default("01") // "01" usually
  dhlParticipation  String? // "01" usually
  
  // Billing Numbers (Abrechnungsnummern)
  dhlBillingNrPaket      String? // 14 digits
  dhlBillingNrKleinpaket String? // 14 digits
  dhlBillingNrWarenpost  String? // 14 digits (legacy/alternative)

  // Defaults
  dhlDefaultPrinterFormat String? @default("910-300-410") // Common export format

  // Deutsche Post Internetmarke settings
  deutschePostUsername      String? // Portokasse Username
  deutschePostPassword      String? // Portokasse Password (encrypted)
  deutschePostClientId      String? // API Client ID
  deutschePostClientSecret  String? // API Client Secret
  deutschePostWalletBalance Float?  @default(0) // Cached wallet balance
  deutschePostEnabled       Boolean @default(false) // Enable/Disable integration

  // Printer Settings
  printerInvoice        String?
  formatInvoice         String? @default("A4")
  printerDeliveryNote   String?
  formatDeliveryNote    String? @default("A4")
  printerLabel          String?
  formatLabel           String? @default("A6")


  // Label Layout Settings
  labelLogoPath    String? // Path to uploaded logo
  labelCompanyName String? // Company name for label
  labelStreet      String? // Sender street
  labelPostalCode  String? // Sender postal code
  labelCity        String? // Sender city
  labelCountry     String? @default("Deutschland") // Sender country
  labelPhone       String? // Sender phone (optional)
  labelEmail       String? // Sender email (optional)

  // Label Size Settings
  labelSizePreset   String? @default("A5") // A5, A6, 4x6, 4x4, CUSTOM
  labelCustomWidth  Int? // Custom width in mm
  labelCustomHeight Int? // Custom height in mm

  // Printer Settings
  defaultPrinter   String? // Default printer name
  autoPrintEnabled Boolean @default(true) // Auto-print after label creation

  // Printer per Shipping Provider (for future DHL/DPD)
  printerDeutschePost String? // Printer for Deutsche Post
  printerDHL          String? // Printer for DHL
  printerDPD          String? // Printer for DPD

  // Email SMTP settings
  smtpHost     String?
  smtpPort     Int?
  smtpUsername String?
  smtpPassword String?
  smtpFrom     String?

  // Number Range Configuration
  orderNumberFormat  String @default("BE-{YYYY}-{####}")
  orderNumberStart   Int    @default(1)
  orderNumberCurrent Int    @default(1)

  invoiceNumberFormat  String @default("RE-{YYYY}-{####}")
  invoiceNumberStart   Int    @default(1)
  invoiceNumberCurrent Int    @default(1)

  deliveryNoteFormat  String @default("LS-{YYYY}-{####}")
  deliveryNoteStart   Int    @default(1)
  deliveryNoteCurrent Int    @default(1)

  supplierOrderFormat  String @default("LB-{YYYY}-{####}")
  supplierOrderStart   Int    @default(1)
  supplierOrderCurrent Int    @default(1)

  customerNumberFormat  String @default("KD-{YYYY}-{####}")
  customerNumberStart   Int    @default(1)
  customerNumberCurrent Int    @default(1)

  // SKU Management
  nextProductId Int    @default(1)
  skuPrefix     String @default("10")

  // Setup Status
  setupCompleted   Boolean   @default(false)
  setupCompletedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_settings")
}

model Customer {
  id               String   @id @default(uuid())
  tenantId         String
  customerNumber   String
  email            String
  firstName        String
  lastName         String
  street           String
  addressAddition  String?
  postalCode       String
  city             String
  country          String   @default("DE")
  phone            String?
  isRepeatCustomer Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  orders           Order[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("customers")
}

model Product {
  id                String               @id @default(uuid())
  userId            String
  user              User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenantId          String
  etsyListingId     String?              // Etsy Listing ID for linking
  sku               String
  gtin              String?
  type              String               @default("SIMPLE")
  name              String
  description       String?
  weight            Int
  price             Float
  imageUrl          String?
  images            String?
  stockQuantity     Int                  @default(0)
  tags              String?
  materials         String?
  variationType1    String?
  variationName1    String?
  variationValue1   String?
  variationType2    String?
  variationName2    String?
  variationValue2   String?
  isActive          Boolean              @default(true)
  showInShop        Boolean              @default(true)
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  orderItems        OrderItem[]
  componentChildren product_components[] @relation("product_components_childProductIdToproducts")
  components        product_components[] @relation("product_components_parentProductIdToproducts")
  variationChildren product_variations[] @relation("product_variations_childProductIdToproducts")
  variations        product_variations[] @relation("product_variations_productIdToproducts")
  
  shippingProfileId String?
  shippingProfile   ShippingProfile? @relation(fields: [shippingProfileId], references: [id])

  @@unique([userId, sku])
  @@index([userId])
  @@index([tenantId])
  @@index([sku])
  @@index([etsyListingId])
  @@index([gtin])
  @@index([isActive])
  @@map("products")
}

model Order {
  id               String            @id @default(uuid())
  tenantId         String
  orderNumber      String            // Removed @unique, added composite below
  externalOrderId  String?
  platform         String? 
  customerId       String
  status           OrderStatus       @default(OPEN)
  shippingCost     Float
  totalPrice       Float
  shippingProvider String?
  trackingNumber   String?
  shippedAt        DateTime?
  notes            String?
  isSyncedToEtsy   Boolean           @default(true) // True = Clean, False = Pending Push
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  documents        Document[]
  items            OrderItem[]
  customer         Customer          @relation(fields: [customerId], references: [id])
  shippingLabels   ShippingLabel[]

  @@index([tenantId])
  @@index([status])
  @@index([externalOrderId])
  @@index([isSyncedToEtsy])
  @@unique([tenantId, orderNumber]) // Unique per tenant
  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id])
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model ShippingLabel {
  id             String           @id @default(uuid())
  orderId        String
  provider       ShippingProvider
  trackingNumber String
  labelUrl       String?
  labelPath      String?
  weight         Int
  cost           Float
  createdAt      DateTime         @default(now())
  order          Order            @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([trackingNumber])
  @@map("shipping_labels")
}

model Document {
  id             String       @id @default(uuid())
  tenantId       String
  orderId        String?
  type           DocumentType
  documentNumber String       // Removed @unique
  filePath       String
  createdAt      DateTime     @default(now())
  order          Order?       @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([orderId])
  @@index([type])
  @@unique([tenantId, documentNumber]) // Unique per tenant
  @@map("documents")
}

model ImportHistory {
  id             String   @id @default(uuid())
  tenantId       String
  fileName       String
  ordersImported Int
  status         String
  errorMessage   String?
  createdAt      DateTime @default(now())

  @@index([tenantId])
  @@map("import_history")
}

model product_components {
  id              String   @id
  parentProductId String
  childProductId  String
  quantity        Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  childProduct    Product  @relation("product_components_childProductIdToproducts", fields: [childProductId], references: [id])
  parentProduct   Product  @relation("product_components_parentProductIdToproducts", fields: [parentProductId], references: [id], onDelete: Cascade)

  @@unique([parentProductId, childProductId])
  @@index([childProductId])
  @@index([parentProductId])
}

model product_variations {
  id             String   @id
  productId      String
  childProductId String?
  sku            String
  price          Float?
  stockQuantity  Int      @default(0)
  name1          String?
  value1         String?
  name2          String?
  value2         String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  childProduct   Product? @relation("product_variations_childProductIdToproducts", fields: [childProductId], references: [id])
  product        Product  @relation("product_variations_productIdToproducts", fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, sku])
  @@index([childProductId])
  @@index([sku])
}

enum Role {
  ADMIN
  USER
}

enum OrderStatus {
  OPEN
  IN_PROGRESS
  SHIPPED
  CANCELLED
}

enum ShippingProvider {
  DHL_KLEINPAKET
  DHL_PAKET
  DEUTSCHE_POST_MAXIBRIEF
  DEUTSCHE_POST_BRIEF_KOMPAKT
  OTHER
}

enum DocumentType {
  INVOICE
  DELIVERY_NOTE
  PICK_LIST
}

model ActivityLog {
  id        String   @id @default(uuid())
  userId    String?
  tenantId  String?
  type      String // INFO, SUCCESS, ERROR, WARNING
  action    String // LOGIN, ETSY_SYNC, IMPORT, ETC
  details   String? // JSON string or text message
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@map("activity_logs")
}

model AutomationRule {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  isActive    Boolean  @default(true)
  trigger     String   // Enum AutomationTrigger as string for flexibility: ORDER_IMPORTED, ORDER_PAID, etc.
  conditions  String   // JSON string of conditions
  actions     String   // JSON string of actions
  priority    Int      @default(0)
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([isActive])
  @@index([trigger])
  @@map("automation_rules")
}

model ShippingProfile {
  id              String   @id @default(uuid())
  tenantId        String
  name            String   // Display Name e.g. "DHL Paket", "Warenpost International"
  provider        String   // DHL, DEUTSCHE_POST
  productCode     String   // V01PAK, V54EPAK, etc.
  billingNumber   String?  // The specific billing number for this method (DHL)
  
  printerName     String?  // Optional: override printer for this method
  
  isActive        Boolean  @default(true)
  
  // Dimensions and Weight
  baseWeight      Float    @default(0) // kg
  length          Float    @default(0) // cm
  width           Float    @default(0) // cm
  height          Float    @default(0) // cm

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  products        Product[] 

  @@index([tenantId])
  @@index([userId])
  @@map("shipping_profiles")
}

model DocumentTemplate {
  id          String   @id @default(uuid())
  tenantId    String
  type        String   // Enum TemplateType: INVOICE, DELIVERY_NOTE, EMAIL
  name        String
  subject     String?  // For Emails
  content     String   // HTML/Text content or config
  
  // PDF specific
  headerText   String?
  footerText   String?
  logoPosition String? @default("RIGHT") // LEFT, CENTER, RIGHT

  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([type])
  @@map("document_templates")
}

model SubscriptionPlan {
  id                 String   @id @default(uuid())
  name               String   // e.g. "Starter", "Pro"
  description        String?
  price              Float    @default(0.0) // Monthly price
  interval           String   @default("MONTHLY") // MONTHLY, YEARLY
  
  // Limits & Quotas
  includedOrders     Int      @default(0)   // Number of orders included
  pricePerExtraOrder Float    @default(0.0) // Fallback price per additional order
  pricingTiers       Json?    // e.g. [{"from": 21, "to": 100, "price": 0.25}, {"from": 101, "to": null, "price": 0.20}]
  
  // Features (JSON list of strings)
  features           String?  // e.g. ["Prioritized Support", "Unlimited Automation"]
  
  // Display Helpers
  isPopular          Boolean  @default(false)
  isActive           Boolean  @default(true)
  buttonText         String?  // Custom button label e.g. "Jetzt starten"
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  users              User[]

  @@map("subscription_plans")
}
